name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
    - name: Build and push Docker image
      run: |
        docker build . --tag ghcr.io/rezondes/choicev-scp:latest
        docker push ghcr.io/rezondes/choicev-scp:latest
        
    - name: Install sshpass
      run: sudo apt-get install -y sshpass

    - name: Deploy via SSH
      env:
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no $SSH_USERNAME@85.114.132.133 << 'EOF'
          # Pull the latest Docker image from GitHub Container Registry
          docker pull ghcr.io/Rezondes/choicev-scp:latest

          # Stop the running container (if exists)
          docker stop blazor-app-container || true

          # Remove the stopped container (if exists)
          docker rm blazor-app-container || true

          # Run a new container with the latest image and mount the PFX file
          docker run -d -p 443:8080 \
            -v /etc/ssl/certs/blazorapp.pfx:/app/blazorapp.pfx \
            --name blazor-app-container ghcr.io/Rezondes/choicev-scp:latest
        EOF
