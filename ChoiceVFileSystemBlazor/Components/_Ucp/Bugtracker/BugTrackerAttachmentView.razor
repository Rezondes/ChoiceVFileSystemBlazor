@using ChoiceVFileSystemBlazor.Services.Vikunja.Models

@if (GetFileUrl().StartsWith("data:image"))
{
    <img src="@GetFileUrl()" style="max-width: 100%; height: auto;" alt=""/>
}
else if (GetFileUrl().StartsWith("data:application/pdf"))
{
    <iframe src="@GetFileUrl()" width="100%" height="600px"></iframe>
}
else if (GetFileUrl().StartsWith("data:text/plain"))
{
    <MudText>@System.Text.Encoding.UTF8.GetString(Attachment.File.Mime)</MudText>
}
else if (GetFileUrl().StartsWith("data:video"))
{
    if (ActiveControls)
    {
        <video controls style="max-width: 100%;">
            <source src="@GetFileUrl()" type="@GetFileUrl().Split(';')[0].Split(':')[1]"/>
            Your browser does not support the video tag.
        </video>
    }
    else
    {
        <video style="max-width: 100%;">
            <source src="@GetFileUrl()" type="@GetFileUrl().Split(';')[0].Split(':')[1]"/>
            Your browser does not support the video tag.
        </video>
    } 
}
else if (GetFileUrl().StartsWith("data:audio"))
{
    if (ActiveControls)
    {
        <audio controls style="width: 100%;">
            <source src="@GetFileUrl()" type="@GetFileUrl().Split(';')[0].Split(':')[1]"/>
            Your browser does not support the audio element.
        </audio>
    }
    else
    {
        <audio style="width: 100%;">
            <source src="@GetFileUrl()" type="@GetFileUrl().Split(';')[0].Split(':')[1]"/>
            Your browser does not support the audio element.
        </audio>
    } 
}
else
{
    <MudText>Unsupported file type: @Attachment.File.Name</MudText>
}

@code {
    [Parameter] public VikunjaAttachment Attachment { get; set; }
    [Parameter] public bool ActiveControls { get; set; }

    private string GetFileUrl()
    {
        var workingAttachment = Attachment;
        
        var base64Data = Convert.ToBase64String(workingAttachment.File.Mime);
        var fileType = "application/octet-stream"; 

        if (workingAttachment.File.Name.EndsWith(".jpg") || workingAttachment.File.Name.EndsWith(".jpeg"))
        {
            fileType = "image/jpeg";
        }
        else if (workingAttachment.File.Name.EndsWith(".png"))
        {
            fileType = "image/png";
        }
        else if (workingAttachment.File.Name.EndsWith(".gif"))
        {
            fileType = "image/gif";
        }
        else if (workingAttachment.File.Name.EndsWith(".bmp"))
        {
            fileType = "image/bmp";
        }
        else if (workingAttachment.File.Name.EndsWith(".pdf"))
        {
            fileType = "application/pdf";
        }
        else if (workingAttachment.File.Name.EndsWith(".txt"))
        {
            fileType = "text/plain";
        }
        else if (workingAttachment.File.Name.EndsWith(".mp4"))
        {
            fileType = "video/mp4";
        }
        else if (workingAttachment.File.Name.EndsWith(".webm"))
        {
            fileType = "video/webm";
        }
        else if (workingAttachment.File.Name.EndsWith(".ogg") || workingAttachment.File.Name.EndsWith(".oga"))
        {
            fileType = "audio/ogg";
        }
        else if (workingAttachment.File.Name.EndsWith(".mp3"))
        {
            fileType = "audio/mp3";
        }
        else if (workingAttachment.File.Name.EndsWith(".wav"))
        {
            fileType = "audio/wav";
        }
        else if (workingAttachment.File.Name.EndsWith(".svg"))
        {
            fileType = "image/svg+xml";
        }

        return $"data:{fileType};base64,{base64Data}";
    }

}